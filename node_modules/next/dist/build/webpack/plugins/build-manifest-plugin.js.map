{"version":3,"sources":["../../../../build/webpack/plugins/build-manifest-plugin.ts"],"names":["isWebpack5","parseInt","webpack","version","generateClientManifest","assetMap","isModern","clientManifest","appDependencies","Set","pages","Object","entries","forEach","page","dependencies","filteredDeps","filter","dep","has","endsWith","length","isJsFile","file","getFilesArray","files","Array","from","BuildManifestPlugin","constructor","options","buildId","modern","createAssets","compilation","assets","namedChunks","polyfillFiles","devFiles","ampDevFiles","lowPriorityFiles","ampFirstPages","ampFirstEntryNames","ampFirstEntryNamesMap","get","entryName","pagePath","push","mainJsChunk","CLIENT_STATIC_FILES_RUNTIME_MAIN","mainJsFiles","polyfillChunk","CLIENT_STATIC_FILES_RUNTIME_POLYFILLS","reactRefreshChunk","CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH","entrypoint","entrypoints","values","isAmpRuntime","name","CLIENT_STATIC_FILES_RUNTIME_AMP","getFiles","replace","filesForEntry","CLIENT_STATIC_FILES_PATH","srcEmptySsgManifest","ssgManifestPath","RawSource","ssgManifestPathModern","keys","sort","reduce","a","c","BUILD_MANIFEST","JSON","stringify","clientManifestPath","modernClientManifestPath","apply","compiler","hooks","make","tap","processAssets","stage","Compilation","PROCESS_ASSETS_STAGE_ADDITIONS","emit"],"mappings":"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","sourcesContent":["import devalue from 'next/dist/compiled/devalue'\nimport webpack, { Compiler, compilation as CompilationType } from 'webpack'\nimport { RawSource } from 'webpack-sources'\nimport {\n  BUILD_MANIFEST,\n  CLIENT_STATIC_FILES_PATH,\n  CLIENT_STATIC_FILES_RUNTIME_MAIN,\n  CLIENT_STATIC_FILES_RUNTIME_POLYFILLS,\n  CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH,\n  CLIENT_STATIC_FILES_RUNTIME_AMP,\n} from '../../../next-server/lib/constants'\nimport { BuildManifest } from '../../../next-server/server/get-page-files'\nimport getRouteFromEntrypoint from '../../../next-server/server/get-route-from-entrypoint'\nimport { ampFirstEntryNamesMap } from './next-drop-client-page-plugin'\n\nconst isWebpack5 = parseInt(webpack.version!) === 5\n\n// This function takes the asset map generated in BuildManifestPlugin and creates a\n// reduced version to send to the client.\nfunction generateClientManifest(\n  assetMap: BuildManifest,\n  isModern: boolean\n): string {\n  const clientManifest: { [s: string]: string[] } = {}\n  const appDependencies = new Set(assetMap.pages['/_app'])\n\n  Object.entries(assetMap.pages).forEach(([page, dependencies]) => {\n    if (page === '/_app') return\n    // Filter out dependencies in the _app entry, because those will have already\n    // been loaded by the client prior to a navigation event\n    const filteredDeps = dependencies.filter(\n      (dep) =>\n        !appDependencies.has(dep) &&\n        (!dep.endsWith('.js') || dep.endsWith('.module.js') === isModern)\n    )\n\n    // The manifest can omit the page if it has no requirements\n    if (filteredDeps.length) {\n      clientManifest[page] = filteredDeps\n    }\n  })\n  return devalue(clientManifest)\n}\n\nfunction isJsFile(file: string): boolean {\n  // We don't want to include `.hot-update.js` files into the initial page\n  return !file.endsWith('.hot-update.js') && file.endsWith('.js')\n}\n\nfunction getFilesArray(files: any) {\n  if (!files) {\n    return []\n  }\n  if (isWebpack5) {\n    return Array.from(files)\n  }\n\n  return files\n}\n\n// This plugin creates a build-manifest.json for all assets that are being output\n// It has a mapping of \"entry\" filename to real filename. Because the real filename can be hashed in production\nexport default class BuildManifestPlugin {\n  private buildId: string\n  private modern: boolean\n\n  constructor(options: { buildId: string; modern: boolean }) {\n    this.buildId = options.buildId\n    this.modern = options.modern\n  }\n\n  createAssets(compilation: any, assets: any) {\n    const namedChunks: Map<string, CompilationType.Chunk> =\n      compilation.namedChunks\n    const assetMap: BuildManifest = {\n      polyfillFiles: [],\n      devFiles: [],\n      ampDevFiles: [],\n      lowPriorityFiles: [],\n      pages: { '/_app': [] },\n      ampFirstPages: [],\n    }\n\n    const ampFirstEntryNames = ampFirstEntryNamesMap.get(compilation)\n    if (ampFirstEntryNames) {\n      for (const entryName of ampFirstEntryNames) {\n        const pagePath = getRouteFromEntrypoint(entryName)\n        if (!pagePath) {\n          continue\n        }\n\n        assetMap.ampFirstPages.push(pagePath)\n      }\n    }\n\n    const mainJsChunk = namedChunks.get(CLIENT_STATIC_FILES_RUNTIME_MAIN)\n\n    const mainJsFiles: string[] = getFilesArray(mainJsChunk?.files).filter(\n      isJsFile\n    )\n\n    const polyfillChunk = namedChunks.get(CLIENT_STATIC_FILES_RUNTIME_POLYFILLS)\n\n    // Create a separate entry  for polyfills\n    assetMap.polyfillFiles = getFilesArray(polyfillChunk?.files).filter(\n      isJsFile\n    )\n\n    const reactRefreshChunk = namedChunks.get(\n      CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH\n    )\n    assetMap.devFiles = getFilesArray(reactRefreshChunk?.files).filter(isJsFile)\n\n    for (const entrypoint of compilation.entrypoints.values()) {\n      const isAmpRuntime = entrypoint.name === CLIENT_STATIC_FILES_RUNTIME_AMP\n\n      if (isAmpRuntime) {\n        for (const file of entrypoint.getFiles()) {\n          if (!(isJsFile(file) || file.endsWith('.css'))) {\n            continue\n          }\n\n          assetMap.ampDevFiles.push(file.replace(/\\\\/g, '/'))\n        }\n        continue\n      }\n      const pagePath = getRouteFromEntrypoint(entrypoint.name)\n\n      if (!pagePath) {\n        continue\n      }\n\n      const filesForEntry: string[] = []\n\n      // getFiles() - helper function to read the files for an entrypoint from stats object\n      for (const file of entrypoint.getFiles()) {\n        if (!(isJsFile(file) || file.endsWith('.css'))) {\n          continue\n        }\n\n        filesForEntry.push(file.replace(/\\\\/g, '/'))\n      }\n\n      assetMap.pages[pagePath] = [...mainJsFiles, ...filesForEntry]\n    }\n\n    // Add the runtime build manifest file (generated later in this file)\n    // as a dependency for the app. If the flag is false, the file won't be\n    // downloaded by the client.\n    assetMap.lowPriorityFiles.push(\n      `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.js`\n    )\n    if (this.modern) {\n      assetMap.lowPriorityFiles.push(\n        `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.module.js`\n      )\n    }\n\n    // Add the runtime ssg manifest file as a lazy-loaded file dependency.\n    // We also stub this file out for development mode (when it is not\n    // generated).\n    const srcEmptySsgManifest = `self.__SSG_MANIFEST=new Set;self.__SSG_MANIFEST_CB&&self.__SSG_MANIFEST_CB()`\n\n    const ssgManifestPath = `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_ssgManifest.js`\n    assetMap.lowPriorityFiles.push(ssgManifestPath)\n    assets[ssgManifestPath] = new RawSource(srcEmptySsgManifest)\n\n    if (this.modern) {\n      const ssgManifestPathModern = `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_ssgManifest.module.js`\n      assetMap.lowPriorityFiles.push(ssgManifestPathModern)\n      assets[ssgManifestPathModern] = new RawSource(srcEmptySsgManifest)\n    }\n\n    assetMap.pages = Object.keys(assetMap.pages)\n      .sort()\n      // eslint-disable-next-line\n      .reduce((a, c) => ((a[c] = assetMap.pages[c]), a), {} as any)\n\n    assets[BUILD_MANIFEST] = new RawSource(JSON.stringify(assetMap, null, 2))\n\n    const clientManifestPath = `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.js`\n\n    assets[clientManifestPath] = new RawSource(\n      `self.__BUILD_MANIFEST = ${generateClientManifest(\n        assetMap,\n        false\n      )};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n    )\n\n    if (this.modern) {\n      const modernClientManifestPath = `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.module.js`\n\n      assets[modernClientManifestPath] = new RawSource(\n        `self.__BUILD_MANIFEST = ${generateClientManifest(\n          assetMap,\n          true\n        )};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n      )\n    }\n\n    return assets\n  }\n\n  apply(compiler: Compiler) {\n    if (isWebpack5) {\n      compiler.hooks.make.tap('NextJsBuildManifest', (compilation) => {\n        // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n        compilation.hooks.processAssets.tap(\n          {\n            name: 'NextJsBuildManifest',\n            // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n            stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n          },\n          (assets: any) => {\n            this.createAssets(compilation, assets)\n          }\n        )\n      })\n      return\n    }\n\n    compiler.hooks.emit.tap('NextJsBuildManifest', (compilation: any) => {\n      this.createAssets(compilation, compilation.assets)\n    })\n  }\n}\n"]}