{"version":3,"sources":["../../../../build/webpack/plugins/font-stylesheet-gathering-plugin.ts"],"names":["isWebpack5","parseInt","webpack","version","minifyCss","css","Promise","resolve","map","then","res","FontStylesheetGatheringPlugin","compiler","gatheredStylesheets","manifestContent","parserHandler","factory","JS_TYPES","type","hooks","parser","for","tap","constructor","name","evaluate","node","state","module","resource","includes","BasicEvaluatedExpression","setRange","range","setExpression","setIdentifier","undefined","call","arguments","length","isNodeCreatingLinkElement","propsNode","props","properties","forEach","prop","key","value","rel","href","OPTIMIZED_FONT_PROVIDERS","some","url","startsWith","push","apply","normalModuleFactory","make","tapAsync","compilation","cb","options","output","path","endsWith","mainTemplate","requireExtensions","source","requireFn","JSON","stringify","finishModules","_","modulesFinished","fontDefinitionPromises","promiseIndex","content","assets","RawSource","processAssets","stage","Compilation","PROCESS_ASSETS_STAGE_ADDITIONS","callee","componentNode"],"mappings":"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","sourcesContent":["import webpack, { compilation as CompilationType, Compiler } from 'webpack'\nimport { namedTypes } from 'ast-types'\nimport { RawSource } from 'webpack-sources'\nimport {\n  getFontDefinitionFromNetwork,\n  FontManifest,\n} from '../../../next-server/server/font-utils'\n// @ts-ignore\nimport BasicEvaluatedExpression from 'webpack/lib/BasicEvaluatedExpression'\nimport { process as minify } from 'cssnano-simple'\nimport { OPTIMIZED_FONT_PROVIDERS } from '../../../next-server/lib/constants'\n\nconst isWebpack5 = parseInt(webpack.version!) === 5\n\nasync function minifyCss(css: string): Promise<string> {\n  return new Promise((resolve) => {\n    minify(css, { map: false }).then((res) => {\n      resolve(res.css)\n    })\n  })\n}\n\nexport class FontStylesheetGatheringPlugin {\n  compiler?: Compiler\n  gatheredStylesheets: Array<string> = []\n  manifestContent: FontManifest = []\n\n  private parserHandler = (\n    factory: CompilationType.NormalModuleFactory\n  ): void => {\n    const JS_TYPES = ['auto', 'esm', 'dynamic']\n    // Do an extra walk per module and add interested visitors to the walk.\n    for (const type of JS_TYPES) {\n      factory.hooks.parser\n        .for('javascript/' + type)\n        .tap(this.constructor.name, (parser: any) => {\n          /**\n           * Webpack fun facts:\n           * `parser.hooks.call.for` cannot catch calls for user defined identifiers like `__jsx`\n           * it can only detect calls for native objects like `window`, `this`, `eval` etc.\n           * In order to be able to catch calls of variables like `__jsx`, first we need to catch them as\n           * Identifier and then return `BasicEvaluatedExpression` whose `id` and `type` webpack matches to\n           * invoke hook for call.\n           * See: https://github.com/webpack/webpack/blob/webpack-4/lib/Parser.js#L1931-L1932.\n           */\n          parser.hooks.evaluate\n            .for('Identifier')\n            .tap(this.constructor.name, (node: namedTypes.Identifier) => {\n              // We will only optimize fonts from first party code.\n              if (parser?.state?.module?.resource.includes('node_modules')) {\n                return\n              }\n              return node.name === '__jsx'\n                ? new BasicEvaluatedExpression()\n                    //@ts-ignore\n                    .setRange(node.range)\n                    .setExpression(node)\n                    .setIdentifier('__jsx')\n                : undefined\n            })\n\n          parser.hooks.call\n            .for('__jsx')\n            .tap(this.constructor.name, (node: namedTypes.CallExpression) => {\n              if (node.arguments.length !== 2) {\n                // A font link tag has only two arguments rel=stylesheet and href='...'\n                return\n              }\n              if (!isNodeCreatingLinkElement(node)) {\n                return\n              }\n\n              // node.arguments[0] is the name of the tag and [1] are the props.\n              const propsNode = node.arguments[1] as namedTypes.ObjectExpression\n              const props: { [key: string]: string } = {}\n              propsNode.properties.forEach((prop) => {\n                if (prop.type !== 'Property') {\n                  return\n                }\n                if (\n                  prop.key.type === 'Identifier' &&\n                  prop.value.type === 'Literal'\n                ) {\n                  props[prop.key.name] = prop.value.value as string\n                }\n              })\n              if (\n                !props.rel ||\n                props.rel !== 'stylesheet' ||\n                !props.href ||\n                !OPTIMIZED_FONT_PROVIDERS.some((url) =>\n                  props.href.startsWith(url)\n                )\n              ) {\n                return false\n              }\n\n              this.gatheredStylesheets.push(props.href)\n            })\n        })\n    }\n  }\n\n  public apply(compiler: Compiler) {\n    this.compiler = compiler\n    compiler.hooks.normalModuleFactory.tap(\n      this.constructor.name,\n      this.parserHandler\n    )\n    compiler.hooks.make.tapAsync(this.constructor.name, (compilation, cb) => {\n      // @ts-ignore\n      if (compilation.options.output.path.endsWith('serverless')) {\n        /**\n         * Inline font manifest for serverless case only.\n         * For target: server drive the manifest through physical file and less of webpack magic.\n         */\n        const mainTemplate = compilation.mainTemplate\n        mainTemplate.hooks.requireExtensions.tap(\n          this.constructor.name,\n          (source: string) => {\n            return `${source}\n                // Font manifest declaration\n                ${\n                  mainTemplate.requireFn\n                }.__NEXT_FONT_MANIFEST__ = ${JSON.stringify(\n              this.manifestContent\n            )};`\n          }\n        )\n      }\n      compilation.hooks.finishModules.tapAsync(\n        this.constructor.name,\n        async (_: any, modulesFinished: Function) => {\n          const fontDefinitionPromises = this.gatheredStylesheets.map((url) =>\n            getFontDefinitionFromNetwork(url)\n          )\n\n          this.manifestContent = []\n          for (let promiseIndex in fontDefinitionPromises) {\n            const css = await fontDefinitionPromises[promiseIndex]\n            const content = await minifyCss(css)\n            this.manifestContent.push({\n              url: this.gatheredStylesheets[promiseIndex],\n              content,\n            })\n          }\n          if (!isWebpack5) {\n            compilation.assets['font-manifest.json'] = new RawSource(\n              JSON.stringify(this.manifestContent, null, '  ')\n            )\n          }\n          modulesFinished()\n        }\n      )\n      cb()\n    })\n\n    if (isWebpack5) {\n      compiler.hooks.make.tap(this.constructor.name, (compilation) => {\n        // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n        compilation.hooks.processAssets.tap(\n          {\n            name: this.constructor.name,\n            // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n            stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n          },\n          (assets: any) => {\n            assets['font-manifest.json'] = new RawSource(\n              JSON.stringify(this.manifestContent, null, '  ')\n            )\n          }\n        )\n      })\n    }\n  }\n}\n\nfunction isNodeCreatingLinkElement(node: namedTypes.CallExpression) {\n  const callee = node.callee as namedTypes.Identifier\n  if (callee.type !== 'Identifier') {\n    return false\n  }\n  const componentNode = node.arguments[0] as namedTypes.Literal\n  if (componentNode.type !== 'Literal') {\n    return false\n  }\n  // Next has pragma: __jsx.\n  return callee.name === '__jsx' && componentNode.value === 'link'\n}\n"]}